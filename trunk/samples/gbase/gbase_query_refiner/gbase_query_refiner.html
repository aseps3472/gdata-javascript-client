<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
<head>
<title>Google Base search refinement sample</title>
<link rel="stylesheet" type="text/css"
    href="http://code.google.com/css/dev_docs.css"/>
<script src="http://www.google.com/jsapi?key=ABQIAAAAVzcu66YGicZvSPDVjflWZRQkdwf30UEryoEcWYgVOc_USNqEkxQkdR_BWf8ImhnhR_oQp2C-OaTnJw"
        type="text/javascript"></script>  
<script type="text/javascript">
<!--
/* Copyright (c) 2007 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/**
 * @fileoverview Queries the attributes feed and snippets feed using criteria 
 * entered in the query box. The snippets feed is parsed to find values for
 * attributes and the values are turned into clickable links which restrict
 * the search.
 */

var LOADING_MESSAGE = "<i>Loading...</i>";
var MAX_QUERY_RESULTS = "250"; 
var NO_RESULTS_MESSAGE = "<i><b>No Results</b></i>";
var RESULTS_DISPLAY = "results_display";
var ATTRIBUTES_DISPLAY = "attributes_display";
var SNIPPETS_DISPLAY = "snippets_display";
var ATTRIBUTES_QUERY_DISPLAY = "attributes_queries_display";
var SNIPPETS_QUERY_DISPLAY = "snippets_queries_display";
var ATTRIBUTES_FEED_URL = "http://www.google.com/base/feeds/attributes";
var SNIPPETS_FEED_URL = "http://www.google.com/base/feeds/snippets";

// Load the Google data JavaScript client library
google.load("gdata", "1");

/** 
 * Adds a JSON script element which queries Google Base and calls the
 * call-back function.
 *
 * @param {HTMLFormElement} query The form element containing the base query
 *     parameters.
 */
function search(query) {
  // Clear any old data to prepare to display the Loading... message.
  clearAttributesDisplay();
  clearSnippetsDisplay();

  // Unhide the sample application's display div.
  document.getElementById(RESULTS_DISPLAY).style.display = "block";

  // Get the user's query from the input box, trim trailing white space and
  // HTML escape the query.
  var userQuery = query.base_query.value;
  if (userQuery.length > 0) {
    var attributesDisplay = document.getElementById(ATTRIBUTES_DISPLAY);
    attributesDisplay.innerHTML = LOADING_MESSAGE;

    var attributeQuery = new google.gdata.client.Query(ATTRIBUTES_FEED_URL); // GDataQuery(ATTRIBUTES_FEED_URL);
    attributeQuery.setParam("bq", userQuery);
    attributeQuery.setParam("max-values", "5");

    var snippetQuery = new google.gdata.client.Query(SNIPPETS_FEED_URL);
    snippetQuery.setParam("bq", userQuery);
    snippetQuery.setParam("max-results", "20");

    var attQueryP = document.getElementById(ATTRIBUTES_QUERY_DISPLAY);
    var queryUri = attributeQuery.getUri();
    attQueryP.innerHTML = "Attributes Query: <a href='" + queryUri + "'>" + 
                          queryUri + "</a>";

    var snipQueryP = document.getElementById(SNIPPETS_QUERY_DISPLAY);
    queryUri =  snippetQuery.getUri();
    snipQueryP.innerHTML = "Snippets Query: <a href='" + queryUri + "'>" +
                           queryUri + "</a>";
    
    var service = new google.gdata.client.GoogleService('gbase', 
        'gbase-js-client-samples');
    service.getFeed(attributeQuery.getUri(), displayAttributes);
    service.getFeed(snippetQuery.getUri(), displaySnippets);
  }
}

/** 
 * Transforms JSON results into unordered list and queries the snippets feed.
 * Builds an unordered list of attributes suggested by the attributes feed.
 * Then it queries the snippets feed with the same parameters used in the
 * attributes query. (This is done by adding a new JSON script element to
 * the page.)
 *
 * @param {JSON} json The json object which was given to this call-back
 *     function as the result of a Base query.
 */
function displayAttributes(json) {
  clearAttributesDisplay();

  // Transform the JSON results into an unordered list of links.
  var ul = document.createElement("ul");
  var attributesDisplay = document.getElementById(ATTRIBUTES_DISPLAY);
  var snippetsDisplay = document.getElementById(SNIPPETS_DISPLAY);
  
  if (!json.feed || !json.feed.entry) {
    attributesDisplay.innerHTML = NO_RESULTS_MESSAGE;
    snippetsDisplay.innerHTML = NO_RESULTS_MESSAGE;
    return;
  }
  
  for (var i = 0; i < json.feed.entry.length; ++i) {
    var entry = json.feed.entry[i]; 
    var li = document.createElement("li");
    var attributeName = entry.title.$t;
    // Transform the attribute name by removing the trailing (type) and 
    // replacing spaces with underscores. Example: item type(text) becomes
    // item_type.
    attributeName = attributeName.slice(0, 
        attributeName.indexOf("(")).replace(/ /g,"_"); 

    // Create a link from the attribute name which will restrict
    // queries to items which have this attribute (whatever the value might
    // be).
    var attributeLink = document.createElement('a');
    var attributeRestriction = "'[" + attributeName + "]'";
    var functionCall = ["javascript:refineSearchByAttribute(", attributeRestriction,
          ");"].join("");

    attributeLink.href = functionCall;
    attributeLink.appendChild(document.createTextNode(entry.title.$t));
    
    

    // Preserve the items in the current list by adding it to the array.
/*  var newValue = document.createElement("li");
  newValue.appendChild(document.createElement("a"));
  
  // Transform underscores in the attribute name into spaces because
  // the bq query parameters accept spaces.
  attributeName = attributeName.replace(/_/g," ");
  var newRestriction = "'[" + attributeName + ":" + value + "]'"; 

  var functionCall = ["javascript:refineSearchByAttribute(", newRestriction, 
      ");"].join("");

  newValue.firstChild.href = functionCall;
  newValue.firstChild.appendChild(document.createTextNode(value));
   
  attributeValueList.appendChild(newValue);
    addValueToList(attributeName, entry.gm$attribute.gm$value.$t,
                           valueList);*/

    var txt = document.createTextNode(entry.title.$t);
    
    // The value list will be used to hold values for this attribute which
    // are found in the snippets feed results.
    var valueList = document.createElement("ul");
    if(entry.gm$attribute && entry.gm$attribute.gm$value) {
        for (var j = 0; j < entry.gm$attribute.gm$value.length; j++) {
          addValueToList(attributeName, entry.gm$attribute.gm$value[j].$t,
                                 valueList);
        }
    }

    li.appendChild(attributeLink);
    li.appendChild(valueList);
    ul.appendChild(li);
  }
  attributesDisplay.appendChild(ul);
}

/** 
 * Removes any HTML in the area for displaying the attributes.
 */
function clearAttributesDisplay() {
  var displayP = document.getElementById(ATTRIBUTES_DISPLAY);
  if(displayP) {
    displayP.innerHTML = "";
  }
}

/** 
 * Renders the JSON from snippets feed query and makes an attributes query.
 * The callback function is included in the script tag for the snippets feed.
 * After pulling the snippets matching the query, this function adds values
 * for the listed attributes from the snippets query results.
 * 
 * @param {JSON} json The json object returned by the Google Base server which
 *     contains the Base query snippets results.
 */
function displaySnippets(json) {
  clearSnippetsDisplay();

  var snippetsDisplay = document.getElementById(SNIPPETS_DISPLAY);
  var attributesDisplay = document.getElementById(ATTRIBUTES_DISPLAY);

  if (!json.feed || !json.feed.entry) {
    snippetsDisplay.innerHTML = NO_RESULTS_MESSAGE;
    return;
  }

  // Transform the JSON snippets results into an unordered list of links.
  var snippetsUl = [];
  snippetsUl.push("<ul>");
  for (var i = 0; i < json.feed.entry.length; ++i) {
    var entry = json.feed.entry[i];
    var alturl;
    for (var k = 0; k < entry.link.length; ++k) {
      if (entry.link[k].rel == "alternate") {
        alturl = entry.link[k].href;
        break;
      }
    }

    if(alturl) {
   
      alturl = alturl.replace(/&/g, "&amp;");
      snippetsUl.push("<li><a href='", alturl, "'>", entry.title.$t, 
                      "</a></li>");
    }
  }
  
  snippetsUl.push("</ul>");
  snippetsDisplay.innerHTML = snippetsUl.join("");
}

/** 
 * Finds the value for an snippet item's attribute if there is one.
 * @param {String} attributeName The attribute whose value we want to find.
 * @param {JSON} jsonEntry JSON representing one item in the snippets feed.
 * @return {String} The value for the specified attribute as found in 
 *     the json snippets entry. Returns null if the attribute is not found.
 */
function getValueOfAttribute(attributeName, jsonEntry) {
  if (jsonEntry["g$" + attributeName]) {
    return jsonEntry["g$" + attributeName].$t;
  }
  return null;
}

/** 
 * Add a new clickable list item under the attribute.
 * Create a new list item under the desired attribute which is clickable. When
 * a user click on the new list item, the query will be refined by adding the
 * attribute-value pair to the query parameters.
 *
 * @param {String} attributeName The attribute under which this value should
 *     be added.
 * @param {String} value The value to be added to the list of attribute 
 *     values.
 * @param {HTMLElement} attributeValueList The list object to which the value 
 *     link should be added.
 */
function addValueToList(attributeName, value, attributeValueList) {
  if (null == value) {
    return;
  }

  // Preserve the items in the current list by adding it to the array.
  var newValue = document.createElement("li");
  newValue.appendChild(document.createElement("a"));
  
  // Transform underscores in the attribute name into spaces because
  // the bq query parameters accept spaces.
  attributeName = attributeName.replace(/_/g," ");
  var newRestriction = "'[" + attributeName + ":" + value + "]'"; 

  var functionCall = ["javascript:refineSearchByAttribute(", newRestriction, 
      ");"].join("");

  newValue.firstChild.href = functionCall;
  newValue.firstChild.appendChild(document.createTextNode(value));
   
  attributeValueList.appendChild(newValue);
}

/** 
 * Add a new parameter to the query and run the new query.
 * This is called when the user clicks on an attribute value. It runs a new
 * query with the restriction that all results have the clicked-on value for
 * the attribute.
 *
 * @param {String} new_restriction A new query parameter to be added to the
 *     Base query.
 */
function refineSearchByAttribute(newRestriction) {
  // Set the query box to display the new retriction being added.
  var queryBox = document.getElementById("query_input");
  var previousQuery = queryBox.value;
  var newQuery = previousQuery + " " + newRestriction;

  queryBox.value = newQuery;
  
  // Requery for a new result set.
  search(document.getElementById("query_form"));
}

/** 
 * Remove any HTML in the area for displaying the list of snippet feed's 
 * items.
 */
function clearSnippetsDisplay() {
  var displayP = document.getElementById(SNIPPETS_DISPLAY);
  displayP.innerHTML = "";
}

/** 
 * Removed JSON script elements created by previous queries.
 */
function removeOldJSONScriptNodes() {
  var snippetsJson = document.getElementById("snippet_json");
  if (snippetsJson) {
    snippetsJson.parentNode.removeChild(snippetsJson);
  } 
  var attributesJson = document.getElementById("attribute_json");
  if (attributesJson) {
    attributesJson.parentNode.removeChild(attributesJson);
  }
}
-->
</script>
</head>
<body>
<h2>Sample using the Google data JavaScript client library with Google Base</h2>
<p><h3>Introduction</h3></p>
<p>Here's an example that shows how to refine the search results from 
<a href="http://base.google.com/base">Google Base</a>, using attributes
from the attributes feed.</p>
<p>Start by entering a search keyword in the Query field. When you click the
"Search" button, a list of items matching your search appears on the right. 
On the left, you see a list of attributes and common values used for items 
that match your search. If you click on one of the attribute values, a search
refinement is added to your query and the page searches Google Base again, 
using your refinement. The items listed on the right now 
have the desired value. The information on the left side of the page comes from
the <a 
href="http://code.google.com/apis/base/attributes-feed.html">attributes feed</a>,
and the items on the right come from the <a 
href="http://code.google.com/apis/base/snippets-feed.html">snippets feed</a>.
</p>
<p><h3>How it works</h3></p>
<p>
This sample uses the 
<a href="http://code.google.com/apis/gdata/client-js.html">Google data JavaScript client library</a> 
to perform queries 
against <a href="http://base.google.com/base">Google Base</a>. 
When you click the search button, the search function is invoked and it
creates queries which are made against the snippets feed and the attributes 
feed. When results come back from Google Base, the displayAttributes and 
displaySnippets functions are called.<br/><br/>
If you would like to learn more about the Google Base API, 
<a href="http://code.google.com/apis/base/">click here</a> or look at the 
references below. 
For more information on the Google data JavaScript client library, please see the <a href="http://code.google.com/apis/gdata/client-js.html">documentation</a>.

</p>
<p><h3>Resources</h3></p>
<ul>
  <li><a href="http://code.google.com/apis/base/">Google Base API</a></li>
  <li><a href="http://code.google.com/apis/gdata/client-js.html">Google data JavaScript Client Library</a></li>
  <li><a href="http://groups.google.com/group/Google-Base-data-API">Google Base data API discussion group</a></li>
  <li><a href="http://code.google.com/support/bin/topic.py?topic=10024">Knowledge base for the Google Base data API</a></li>
</ul>
<p><h3>Sample Application</h3></p>
<p>
<form id="query_form" onSubmit="return false">
 <p>Your query: <input id="query_input" type="text" name="base_query" 
                 size="100" value="digital camera" /> 
  <button id="search_button" onClick="search(this.form)">Search</button>
 </p>
 
</form>
<div id="results_display" style="display:none">
  <p id="snippets_queries_display">
  Snippets Query: 
  </p>
  <p id="attributes_queries_display">
  Attributes Query: 
  </p>
  <br/>
  <div style="float: left; width: 30%">
    <h3>Attributes</h3>
    <br/>
    <div id="attributes_display">
    </div>
  </div>
  <div style="float: left; width: 30%">
    <h3>Snippets</h3>
    <br/>
    <div id="snippets_display">
    </div>
  </div>
<div>
</p>
<div>
</div>
</body>
</html>

