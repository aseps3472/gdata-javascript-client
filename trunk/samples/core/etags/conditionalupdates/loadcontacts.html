<html>
  <head>
    <title></title>
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript">
      google.load('gdata', '2.x', { packages : ['contacts'] });

      var contactFeedUri = 'http://www.google.com/m8/feeds/contacts/default/full';
      var GROUP_TITLE = 'JavaScript Client Sample';
      var groupId = null;
      var groupMembers = null;
      var service;

      function errorHandler(e, resp) {
        var errorDiv = document.getElementById('errorDiv');
        msg = 'ERROR: ' + (e.cause ? e.cause.statusText : e.message);
        errorDiv.innerHTML = msg;
        errorDiv.style.display = 'block';
        hideLoadingImage();
      }

      function addEvent(obj, type, fn)
      {
        if (obj.addEventListener) {
          obj.addEventListener(type, fn, false);
        } else if (obj.attachEvent) {
          obj['e' + type + fn] = fn;
          obj[type + fn] = function() { obj['e' + type + fn](window.event); }
          obj.attachEvent('on' + type, obj[type + fn]);
        }
      }

      function formatDate(date) {
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
      }

      function updateLastUpdate() {
        var msg = 'Last Update: ' + formatDate(new Date());
        document.getElementById('timestamp').innerHTML = msg;
      }

      function showLoadingImage() {
        document.getElementById('loadingDiv').style.display = 'block';
        document.getElementById('doneDiv').style.display = 'none';
        document.getElementById('errorDiv').style.display = 'none';
      }

      function hideLoadingImage() {
        document.getElementById('loadingDiv').style.display = 'none';
        document.getElementById('doneDiv').style.display = 'block';
      }

      function getForceUpdate() {
        if (document.getElementById('chkForceUpdate').checked) {
          return true;
        }
        return false;
      }
      
      function updateContact(pos) {
        showLoadingImage();
        var entry = groupMembers[pos];
        if (entry == null) {
          hideLoadingImage();
          return;
        }
        var newTitle = prompt('Enter a new name for this contact',
            entry.getTitle().getText());
        if (!newTitle) {
          hideLoadingImage();
          return;
        }
        var opt_params = {};
        if (getForceUpdate()) {
          opt_params['etag'] = '*';
        }
        entry.setTitle(google.gdata.atom.Text.create(newTitle));
        entry.updateEntry(loadGroupMembers, errorHandler, opt_params);
      }

      function deleteContact(pos) {
        showLoadingImage();
        var entry = groupMembers[pos];
        if (entry == null) {
          hideLoadingImage();
          return;
        }
        var opt_params = {};
        if (getForceUpdate()) {
          opt_params['etag'] = '*';
        }
        entry.deleteEntry(loadGroupMembers, errorHandler, opt_params);
      }

      function createContact() {
        showLoadingImage();
        var title = prompt('Enter a name for this contact', '');
        if (!title) {
          hideLoadingImage();
          return;
        }
        var entry = new google.gdata.contacts.ContactEntry();
        entry.setTitle(google.gdata.atom.Text.create(title));
        var membershipInfo = new google.gdata.contacts.GroupMembershipInfo();
        membershipInfo.setHref(groupId);
        entry.addGroupMembershipInfo(membershipInfo);
        service.insertEntry(contactFeedUri, entry, loadGroupMembers,
            errorHandler, google.gdata.contacts.ContactEntry);
      }

      function loadGroupMembers() {
        showLoadingImage();
        var query = new google.gdata.contacts.ContactQuery(contactFeedUri);
        query.setParam('group', groupId);
        service.getContactFeed(query, loadGroupMembersHandler, errorHandler);
      }

      function loadGroupMembersHandler(feedRoot) {
        var doneDiv = document.getElementById('doneDiv');
        var contentDiv = document.getElementById('contentDiv');
        doneDiv.removeChild(contentDiv);
        contentDiv = document.createElement('div');
        contentDiv.id = 'contentDiv';

        groupMembers = feedRoot.feed.getEntries();
        if (groupMembers.length > 0) {
          var table = document.createElement('table');
          table.border = 1;
          var thead = document.createElement("thead");
          thead.style.height = '0px';
          table.appendChild(thead);
          var tfoot = document.createElement("tfoot");
          tfoot.style.height = '0px';
          table.appendChild(tfoot);
          var tbody = document.createElement("tbody");
          for (var i = 0; i < groupMembers.length; i++) {
            var entry = groupMembers[i];

            var tr = document.createElement('tr');

            var td = document.createElement('td');
            td.innerHTML = entry.getTitle().getText();
            tr.appendChild(td);

            var updateLink = document.createElement('a');
            updateLink.href = '#';
            updateLink.innerHTML = '[edit]';
            addEvent(updateLink, 'click', function(pos) {
              return function() {
                updateContact(pos);
              };
            }(i));
            td = document.createElement('td');
            td.appendChild(updateLink);
            tr.appendChild(td);

            var deleteLink = document.createElement('a');
            deleteLink.href = '#';
            deleteLink.innerHTML = '[delete]';
            addEvent(deleteLink, 'click', function(pos) {
              return function() {
                deleteContact(pos);
              };
            }(i));
            td = document.createElement('td');
            td.appendChild(deleteLink);
            tr.appendChild(td);

            tbody.appendChild(tr);
          }
          table.appendChild(tbody);
          contentDiv.appendChild(table);
        }

        doneDiv.appendChild(contentDiv);

        updateLastUpdate();
        hideLoadingImage();
      }

      function loadContactGroupFeed() {
        service = new google.gdata.contacts.ContactsService('jsv2test');
        var feedUri = 'http://www.google.com/m8/feeds/groups/default/full';
        service.getContactGroupFeed(feedUri, loadContactGroupFeedHandler,
            errorHandler);
      }

      function loadContactGroupFeedHandler(feedRoot) {
        var entries = feedRoot.feed.getEntries();
        for (var i = 0; i < entries.length; i++) {
          var groupEntry = entries[i];
          var groupTitle = groupEntry.getTitle().getText();
          if (groupTitle == GROUP_TITLE) {
            groupId = groupEntry.getId().getValue();
            loadGroupMembers();
            return;
          }
        }
        alert('ERROR: Could not load Contact Group.  Aborting application.');
      }

      google.setOnLoadCallback(loadContactGroupFeed);
    </script>
  </head>
  <body>

    <div id="loadingDiv">
      <img src="ajax-loader.gif" />
    </div>
    
    <div id="doneDiv" style="display: none;">
      <div id="errorDiv" style="border: 1px solid; margin: 10px 0px; padding:15px 10px 15px 50px; font-size:13px; color: #D8000C; background-color: #FFBABA; display: none;"></div>
      <div id="timestamp"></div>
      <a href="#" onclick="loadGroupMembers(); return false;">Reload Contacts</a>
      <br /><br />
      <a href="#" onclick="createContact(); return false;">Create New Contact</a>
      <br /><br />
      <input type="checkbox" id="chkForceUpdate">Force update/delete? (Sets "If-Match" header to "*")</input>
      <br /><br />
      <div id="contentDiv">
      </div>
    </div>

  </body>
</html>
