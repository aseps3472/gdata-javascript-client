<html>
<head>
<title>Sample using GData JS client library to retrieve stock information in Spreadsheets</title>
<link rel="stylesheet" type="text/css" href="http://code.google.com/css/dev_docs.css">
<!--
/* Copyright (c) 2007 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
-->
<script src="../../thirdparty/MochiKit.js" type="text/javascript"></script>
<script src="../../thirdparty/PlotKit_Packed.js" type="text/javascript"></script>
<script type="text/javascript" src="http://gd.google.com/js/gdata-core-bundle.js"></script>
<style type="text/css">
#stock table {
  border: 0px;
  margin: 1em 0 0 26px;
  border-collapse:collapse;
  clear:right;
  }
  
#stock th {
  font-size:12px;
  border: 0px solid #FFFFFF;
  border-bottom:1px solid #999999;
  border-top:1px solid #999999;
  font-weight:bold;
  text-align:left;
  margin-left:3%;	
  text-align: left;
  background-color: #efefef;
  }
  
#stock td {
  font-size: 11px;
  border: 0px solid #FFFFFF;
  border-bottom:1px solid #999999;
  background: #fff;
  text-align:left;
  margin-left:3%;	
  padding: 6px 6px 6px 12px;
  vertical-align:top;
  }
</style>
<script type="text/javascript">
<!--

/**
 * The cell based feed preserves white space in the first row as column header.
 * Uses the cell based feed to get column header information for display.
 */
function loadSpreadsheetsCellFeed() {
  var service = new GDataGoogleService('wise','gdata-js-sample-stock');
  var query = new GDataQuery(
      'http://spreadsheets.google.com/feeds/cells/' +
      'o10288305351702791548.5996115032173552953/od6/public/values?max-row=1');
  // Retrieves the feed, specifying listColumnHeaders as the callback function
  // to be used after the feed is successfully retrieved
  service.getFeed(query.getUri(), listColumnHeaders);
}

/**
 * Loads the sample public Spreadsheets feed that contains Google Finance data
 * such as ticker, market price, high, low, volume and so on.
 * To learn how to use GoogleFinance function in Google Spreadsheets, 
 * go to http://docs.google.com/support/spreadsheets/bin/answer.py?answer=54198
 *
 * @param {table} table is the table element to be populated
 */
function loadStockDataFeed(table) {
  var service = new GDataGoogleService('wise', 'gdata-js-sample-stock-webpage');
  var query = new GDataQuery(
      'http://spreadsheets.google.com/feeds/list/' +
      'o10288305351702791548.5996115032173552953/od6/public/values');
  service.getFeed(query.getUri(), 
                  function (feedRoot) { 
                    listStocks(feedRoot, table);
                  });
}


/**
 * Callback function for the GData JS Client Library to call with 
 * a feed of the column headers for the worksheet.  Builds the table 
 * format for displaying stock data.
 *
 * @param {json} feedRoot is the root of the feed, containing all entries 
 */ 
function listColumnHeaders(feedRoot) {
  var entries = feedRoot.feed.entry;
  var stockDiv = document.getElementById('stock');

  // clears any previous elements in the stockDiv container 
  if (stockDiv.childNodes.length > 0) {
    stockDiv.removeChild(stockDiv.childNodes[0]);
  }	  

  // displays the title of the worksheet
  document.getElementById('stockTitle').innerHTML =
      feedRoot.feed.title.$t;

  // creates a table to hold the stock data
  var table = document.createElement('table');
  table.setAttribute('id', 'stockdata');

  var header = document.createElement('thead');
  var headerTr = document.createElement('tr');
  header.appendChild(headerTr);
  table.appendChild(header);

  // empty first column hidden for plotkit rownumber
  var hiddenTh = document.createElement('th');
  hiddenTh.style.display = 'none';
  headerTr.appendChild(hiddenTh);

  // for each of the column headers, represented as entries in the feed
  for (var i = 0; i < entries.length; i++) {
    var entry = entries[i];
    var th = document.createElement('th');
    th.innerHTML = entry.gs$cell.$t;
    headerTr.appendChild(th);
  }
  stockDiv.appendChild(table);

  // calls method to load the stock data, passing it the table we just created
  // the table already contains the header rows created in this method
  loadStockDataFeed(table);   
}

/**
 * Callback function for the GData JS Client Library to call with a feed of
 * spreadsheet list entries retrieved.  Each entry represents an individual
 * row of the spreadsheet which contains data for a specified stock.
 *
 * Populates the provide table element with the stock data contained in the
 * feed. 
 *
 * @param {json} feedRoot is the root of the feed, containing all entries 
 * @param {table} table is the table element, with header rows already created 
 */ 
function listStocks(feedRoot, table) {
  var entries = feedRoot.feed.entry;

  var tbody = document.createElement('tbody');
  table.appendChild(tbody);

  // for each row of the spreadsheet 
  var l = entries.length;
  for (var i = 0; i < l; i++) {
    var row = document.createElement('tr');
    var entry = entries[i];

    // create hidden row numbers needed for plotkit barchart
    var rowNumTd = document.createElement('td');
    rowNumTd.style.display = 'none';
    rowNumTd.innerHTML = i + 1;
    row.appendChild(rowNumTd);

    // for each child element of the entry, loop through to find elements 
    // beginning with gsx -- these represent each cell in the row
    // j is an icrementer for gsx elements
    var j = 1;
    for (child in entry) {
      if (child.substring(0,3) == 'gsx') {
        var td = document.createElement('td');
        // the 5th and 6th gsx elements represent the day change and day
        // change percentage respectively -- we want these to be colored green 
        // for positive movement and red for negative movement  
        if (j == 5 || j == 6) {
          if (entry[child].$t.substring(0,1) == '-') {
            td.style.color = 'red';
          } else {
            td.style.color = 'green';
          }
          td.innerHTML = entry[child].$t;
        } else if (j == 1) {
          // the 1st gsx element represents the stock symbol 
          // we provide a link to the Google Finance site for these
          var stockLinkHref = 'http://finance.google.com/finance?q=';
          var stockLink = document.createElement('a');
          stockLink.setAttribute('href', stockLinkHref + entry[child].$t);
          stockLink.appendChild(document.createTextNode(entry[child].$t));
          td.appendChild(stockLink);
        } else {
          td.innerHTML = entry[child].$t;
        }
        row.appendChild(td);
        j = j + 1;
      }
    }
    tbody.appendChild(row);
  }
  // creates a chart using the data in this table and the PlotKit library
  setupChart(tbody);
}

/**
 * Creates the bar chart representing the current value of each of the stocks. 
 * This would be more useful if we kept track of day-to-day changes, but is 
 * still great for demonstration purposes. 
 *
 * @param {tbody} tbody is the tbody containing the data to graph 
 */
function setupChart(tbody) {
  var layout = new PlotKit.Layout('bar');
  // the row id number (value in first column of each table row) is the xcol
  // the ycol (in the third column of the table) is the last stock price
  // the stock ticker (in the second column of the table) is the label

  // NOTE: we hid the first column using style=display:none in the
  // listStocks() method
  layout.addDatasetFromTable('dataset1', tbody.parentNode, xcol = 0, ycol = 2, 
      labelCol = 1);
  layout.evaluate();
  var chart = new SweetCanvasRenderer($('graph'), layout);
  chart.render();
}

//-->
</script>
</head>
<body onLoad="loadSpreadsheetsCellFeed()">
<h2>Stock Sample - Using Google Spreadsheets and GData JavaScript Client Library</h2>
<p><b>Note:</b>  The stock data in this sample is delayed by a short period of time depending on the exchange on which the stock is traded.  This delay is usually between 15 and 20 minutes.  <a href="http://www.google.com/help/stock_disclaimer.html">Disclaimer</a></p> 
<p>
  <b>How to get near real time stock data in Google Spreadsheets?</b>
  <br><br>
  <b>The <a href="http://docs.google.com/support/spreadsheets/bin/answer.py?answer=54198">GoogleFinance()</a></b> 
   function in Google Spreadsheets allows you to write simple formula to query stock data. <br>
   e.g. To get the current stock price for Google( Ticker: GOOG), enter the following function in Google Spreadsheets cell: <br>
   <pre>=GoogleFinance("GOOG", "price") </pre>
</p>
<p>
  An example spreadsheet is available in both <a href="http://spreadsheets.google.com/pub?key=pfMX-JDVnx445pRVd2no2Uw&output=html">HTML</a>
  and <a href="http://spreadsheets.google.com/feeds/list/o10288305351702791548.5996115032173552953/od6/public/values">XML</a> format. 
</p>
<h3 id="stockTitle"></h3>
<div id="stock"><p>Loading...</p></div>
<br><br>
<div style="margin-left: 20px; width: 250px; height: 200px;" ><canvas id="graph" height='200' width='500'></canvas></div>
<div>
<h3>Resources:</h3>
<p>
  <ul>
    <li><a href="http://code.google.com/apis/spreadsheets/">Google Spreadsheets Data API</a></li>
    <li><a href="http://code.google.com/apis/gdata/client-js.html">GData JavaScript Client Library</a></li>
    <li><a href="http://docs.google.com/support/spreadsheets/bin/answer.py?answer=54198">GoogleFinance() function</a></li>
    <li><a href="http://docs.google.com/support/spreadsheets/bin/answer.py?answer=54199">Other interesting data available from within Google Spreadsheets</a></li>
  </ul>
</p>
</div>
</body>
</html>

