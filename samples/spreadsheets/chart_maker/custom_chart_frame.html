<HTML xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Google Spreadsheet -> Chart Output</title>
<script src="http://gdata-javascript-client.googlecode.com/svn/trunk/samples/thirdparty/webfxchart/excanvas.js"
    type="text/javascript"></script>
<script src="http://gdata-javascript-client.googlecode.com/svn/trunk/samples/thirdparty/webfxchart/chart.js"
    type="text/javascript"></script>
<script src="http://gdata-javascript-client.googlecode.com/svn/trunk/samples/thirdparty/webfxchart/canvaschartpainter.js"
    type="text/javascript"></script>
<script src="http://www.google.com/jsapi?key=ABQIAAAAVzcu66YGicZvSPDVjflWZRQkdwf30UEryoEcWYgVOc_USNqEkxQkdR_BWf8ImhnhR_oQp2C-OaTnJw"
    type="text/javascript"></script>
<link href="http://gdata-javascript-client.googlecode.com/svn/trunk/samples/thirdparty/webfxchart/canvaschart.css"
    rel="stylesheet" type="text/css"/>

<script type="text/javascript">
/* Copyright (c) 2007 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

// Load the Google data JavaScript client library
google.load("gdata", "1");

function SpreadsheetsChart(div, json, params) {
  this.div = div;
  this.json = json;
  this.params = params;
  div.style.width = this.params['chartWidth'];
  div.style.height = this.params['chartHeight'];
  
  this.params['densityX'] = parseInt(this.params['densityX']);
  this.params['densityY'] = parseInt(this.params['densityY']);
}

/**
* This function initializes the chart, sets chart properties,
* then iterates through the loaded feed to add data series to the chart.
*/
SpreadsheetsChart.prototype.loadAndDraw = function() {
  var chart = new Chart(this.div);
  chart.setDefaultType(CHART_LINE);

  if (this.params['showLegend'] == 'true') {
    chart.setShowLegend(true);
  } else {
    chart.setShowLegend(false);
  }

  chart.setGridDensity(this.json.feed.entry.length, this.params['densityY']);

  // This for loop corresponds to the "Show labels every X gridlines" setting.
  // It pushes a label if it's on the Xth gridline and a label exists, 
  // otherwise it pushes an empty string. 
  var horizontalLabels = [];
  for (var j = 0; j < this.json.feed.entry.length; j++) {
    var entry = this.json.feed.entry[j];
    if (j % this.params['densityX'] == 0 && entry['gsx$' + this.params['xAxis']]) {
      horizontalLabels.push(entry['gsx$' + this.params['xAxis']].$t);
    } else {
      horizontalLabels.push('');
    }
  }
  chart.setHorizontalLabels(horizontalLabels);

  var dataSeriesArray = this.params['ds'];
  for (var j = 0; j < dataSeriesArray.length; j++) {
    var dataSeries = dataSeriesArray[j].split(',');
    if (dataSeries.length == 3) {
      var dataSeriesName = dataSeries[0];
      var dataSeriesColor = dataSeries[1];
      var dataSeriesType = dataSeries[2];
      var dataSeriesValues = new Array();
      for (var k = 0; k < this.json.feed.entry.length; k++) {
        var entry = this.json.feed.entry[k];
        if (entry['gsx$' + dataSeriesName]) {
          dataSeriesValues.push(parseFloat(entry['gsx$' + dataSeriesName].$t));
        }
      }
      chart.add(dataSeriesName, '#' + dataSeriesColor, dataSeriesValues, 
          dataSeriesType);
    }
  }
  chart.draw();
}

/**
* Utility function to extract parameters appended to URL.
* @param {String} name Name of parameter in URL
* @return {String} Value of parameter, or '' if not found
*/
function getURLParam(name) {
  var regexS = '[\\?&]' + name + '=([^&#]*)';
  var regex = new RegExp(regexS);
  var results = regex.exec(window.location.href);
  return (results == null ? '' : results[1]);
}

/**
* Callback function for the spreadsheets query.
* This function uses the values from the URL to set chart parameters.
* It then creates a new SpreadsheetsChart object, passing in the worksheet JSON,
* div to hold the chart in, and the parameters.
*/
function loadWorksheet(json) {
  var params = {'chartWidth':'', 'chartHeight':'', 'ds':'', 'chartType':'', 
                'xAxis':'', 'densityX':'', 'densityY':'', 'showLegend':''};

  for (paramName in params) {
   params[paramName] = getURLParam(paramName);
  }
  params['ds'] = params['ds'].split(';');

  var div = document.getElementById('chart');

  var spreadsheetsChart = new SpreadsheetsChart(div, json, params);
  spreadsheetsChart.loadAndDraw();
}

/**
 * Callback function for the GData JS Client Library to call when an error
 * occurs during the retrieval of the feed.  
 * @param {Error} e is an instance of an Error 
 */
function handleGDError(e) {
  alert('There has been an error trying to retrieve that feed. ' +   
        'Please check that you correctly typed the key and worksheet ID,' +
        ' and that you have published the worksheet.'); 
}

/**
 * Calls populateVars to set the global variables, changes chart div dimensions.
 * Uses the Javascript GData Client Library to send a query to 
 * retrieve spreadsheet feed, set the callback function to loadWorksheetJSON
 * and the error handling function to handleGDError.
 */
function getJSON() {
  var param_ssKey = getURLParam('ssKey');
  var param_wsId = getURLParam('wsId');
  
  var service = new google.gdata.client.GoogleService('wise', 'gdata-js-chart');
  var query = new google.gdata.client.Query(
    'http://spreadsheets.google.com/feeds/list/' + 
    param_ssKey + '/' + param_wsId + '/public/values');
  service.getFeed(query.getUri(), loadWorksheet, handleGDError);
}

</script>

</head>
<body onload="getJSON()">

<div id="chart" class="chart"></div>

</body>
</html>


